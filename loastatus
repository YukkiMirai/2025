// Logic m·ªõi: ch·ªâ g·ª≠i webhook khi tr·∫°ng th√°i thay ƒë·ªïi t·ª´ offline sang online
  var refreshInterval; // ƒë·ªÉ l∆∞u interval
  var isProcessing = false; // flag ƒë·ªÉ tr√°nh g·ª≠i ƒë·ªìng th·ªùi
  var initialStatus = null; // l∆∞u tr·∫°ng th√°i ban ƒë·∫ßu

  const url = "https://discord.com/api/webhooks/1415262191996768307/Rdfm_1vHjqemMDVvObRcDTmNyF_3RRdhGI82EJJOTuExBFjQlqLLhgB3ZDRF-SgvGIr3";

  const payload = {
    "username": "ƒê·ªôi tr∆∞·ªüng ch√≥!",
    "avatar_url": "https://i.imgur.com/AfFp7pu.png",
    "content": "Th√¥ng b√°o! <@&1141669486697644032>",
    "embeds": [
      {
        "title": "Th√¥ng b√°o",
        "description": "Brelshaza is online üéâ",
        "color": 15258703
      }
    ]
  };

  // H√†m ki·ªÉm tra localStorage c√≥ h·∫øt h·∫°n kh√¥ng (1 ng√†y)
  function isWebhookDataExpired() {
    var webhookTime = localStorage.getItem('brelshaza_webhook_time');
    if (!webhookTime) return true;
    
    var savedTime = new Date(webhookTime);
    var currentTime = new Date();
    var diffHours = (currentTime - savedTime) / (1000 * 60 * 60);
    
    return diffHours >= 24; // 24 gi·ªù = 1 ng√†y
  }

  // H√†m g·ª≠i webhook
  function sendWebhook(isManual = false) {
    if (isProcessing) return;
    
    isProcessing = true;
    console.log(isManual ? "G·ª≠i webhook th·ªß c√¥ng..." : "G·ª≠i webhook t·ª± ƒë·ªông...");
    
    // L∆∞u tr·∫°ng th√°i ƒë√£ g·ª≠i v√†o localStorage
    localStorage.setItem('brelshaza_webhook_sent', 'true');
    localStorage.setItem('brelshaza_webhook_time', new Date().toISOString());

    $.ajax({
      url: url,
      method: "POST",
      contentType: "application/json",
      data: JSON.stringify(payload),
      timeout: 10000,
      success: function (res) {
        console.log("Webhook ƒë√£ g·ª≠i th√†nh c√¥ng:", res);
        isProcessing = false;
      },
      error: function (err) {
        console.error("L·ªói khi g·ª≠i webhook:", err);
        // N·∫øu l·ªói th√¨ x√≥a flag ƒë·ªÉ c√≥ th·ªÉ th·ª≠ l·∫°i
        localStorage.removeItem('brelshaza_webhook_sent');
        localStorage.removeItem('brelshaza_webhook_time');
        isProcessing = false;
      }
    });
  }

  // H√†m ki·ªÉm tra v√† g·ª≠i webhook
  function checkAndSendWebhook() {
    // Ki·ªÉm tra localStorage c√≥ h·∫øt h·∫°n kh√¥ng
    if (isWebhookDataExpired()) {
      localStorage.removeItem('brelshaza_webhook_sent');
      localStorage.removeItem('brelshaza_webhook_time');
    }
    
    // Ki·ªÉm tra xem ƒë√£ g·ª≠i webhook trong ng√†y ch∆∞a
    var hasSentWebhook = localStorage.getItem('brelshaza_webhook_sent') === 'true';
    
    // t√¨m ph·∫ßn t·ª≠ c√≥ class v√† aria-label ch·ª©a 'Brelshaza'
    var $el = $(".ags-ServerStatus-content-responses-response-server-name[aria-label*='Brelshaza']");

    if ($el.length) {
      var currentStatus = $el.attr("aria-label");
      document.title = currentStatus;
      
      // N·∫øu ch∆∞a c√≥ initial status th√¨ l∆∞u l·∫°i
      if (initialStatus === null) {
        initialStatus = currentStatus;
        console.log("Tr·∫°ng th√°i ban ƒë·∫ßu:", initialStatus);
        
        // N·∫øu ban ƒë·∫ßu ƒë√£ online th√¨ kh√¥ng g·ª≠i webhook
        if (initialStatus === "Brelshaza is online") {
          console.log("Server ƒë√£ online t·ª´ ƒë·∫ßu, kh√¥ng g·ª≠i webhook");
          return;
        }
      }
      
      // Ch·ªâ g·ª≠i webhook khi:
      // 1. Tr·∫°ng th√°i thay ƒë·ªïi t·ª´ offline sang online
      // 2. Ch∆∞a g·ª≠i webhook trong ng√†y
      // 3. Kh√¥ng ƒëang x·ª≠ l√Ω
      if (currentStatus === "Brelshaza is online" && 
          initialStatus !== "Brelshaza is online" && 
          !hasSentWebhook && 
          !isProcessing) {
        console.log("Ph√°t hi·ªán server chuy·ªÉn t·ª´ offline sang online!");
        sendWebhook(false);
      }

    } else {
      document.title = "Kh√¥ng t√¨m th·∫•y";
    }
  }

  $(document).ready(function () {
    // Ki·ªÉm tra ngay khi trang load
    checkAndSendWebhook();

    // Th√™m s·ª± ki·ªán click v√†o div ƒë·ªÉ g·ª≠i webhook th·ªß c√¥ng
    $(document).on('click', '.ags-ServerStatus-content-responses-response-server-name[aria-label*="Brelshaza"]', function() {
      var currentStatus = $(this).attr("aria-label");
      if (currentStatus === "Brelshaza is online") {
        console.log("Click th·ªß c√¥ng ƒë·ªÉ g·ª≠i webhook");
        sendWebhook(true);
      } else {
        console.log("Server ch∆∞a online, kh√¥ng th·ªÉ g·ª≠i webhook");
      }
    });

    // Auto refresh trang sau m·ªói 5 gi√¢y
    refreshInterval = setInterval(function () {
      // Ch·ªâ reload n·∫øu ch∆∞a g·ª≠i webhook ho·∫∑c webhook ƒë√£ h·∫øt h·∫°n
      var hasSentWebhook = localStorage.getItem('brelshaza_webhook_sent') === 'true';
      var isExpired = isWebhookDataExpired();
      
      if (!isProcessing && (!hasSentWebhook || isExpired)) {
        location.reload();
      }
    }, 5000);

    // Th√™m n√∫t reset ƒë·ªÉ test (t√πy ch·ªçn)
    $('body').append('<button onclick="localStorage.removeItem(\'brelshaza_webhook_sent\'); localStorage.removeItem(\'brelshaza_webhook_time\'); location.reload();" style="position:fixed;top:10px;right:10px;z-index:9999;background:#ff4444;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;">Reset Webhook</button>');
    
    // Th√™m n√∫t g·ª≠i webhook th·ªß c√¥ng
    $('body').append('<button id="sendWebhookBtn" style="position:fixed;top:10px;right:130px;z-index:9999;background:#00aa00;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;">G·ª≠i Webhook</button>');
    
    // S·ª± ki·ªán click n√∫t g·ª≠i webhook
    $('#sendWebhookBtn').click(function() {
      var $el = $(".ags-ServerStatus-content-responses-response-server-name[aria-label*='Brelshaza']");
      if ($el.length) {
        var currentStatus = $el.attr("aria-label");
        if (currentStatus === "Brelshaza is online") {
          console.log("G·ª≠i webhook b·∫±ng n√∫t th·ªß c√¥ng");
          sendWebhook(true);
          $(this).text('ƒê√£ g·ª≠i!').css('background', '#888888').prop('disabled', true);
          setTimeout(() => {
            $(this).text('G·ª≠i Webhook').css('background', '#00aa00').prop('disabled', false);
          }, 3000);
        } else {
          alert("Server ch∆∞a online, kh√¥ng th·ªÉ g·ª≠i webhook!");
        }
      } else {
        alert("Kh√¥ng t√¨m th·∫•y th√¥ng tin server!");
      }
    });
  });
